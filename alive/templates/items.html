<div class="container mx-auto p-4 max-w-4xl">
    {% if breadcrumbs %}
    <div class="text-sm breadcrumbs mb-4">
        <ul>
            {% for crumb in breadcrumbs %}
            <li>
                {% if crumb.url %}
                <a href="{{crumb.url}}" class="link">{{crumb.label}}</a>
                {% else %}
                <span>{{crumb.label}}</span>
                {% endif %}
            </li>
            {% endfor %}
        </ul>
    </div>
    {% endif %}

    <div class="flex justify-between items-center mb-6">
        <h1 class="text-3xl font-bold">{{model_name}}</h1>
        {% if not creating %}
        <div class="flex gap-2">
            {% if filters %}
            <button class="btn btn-outline" phx-click="open_picker">+ Add Existing</button>
            {% endif %}
            <button class="btn btn-primary" phx-click="start_create">+ Create New</button>
        </div>
        {% endif %}
    </div>

    {% if creating %}
    <div class="card bg-base-100 shadow-sm border-2 border-primary mb-4">
        <div class="card-body create-form" id="create-form" phx-hook="AutoFocus">
            <h2 class="card-title">New {{model_name_singular}}</h2>
            {% if create_error %}
            <div class="alert alert-error">{{create_error}}</div>
            {% endif %}
            {% for field in create_fields %}
            <fieldset class="fieldset w-full">
                <legend class="fieldset-legend">{{field.label}}{% if field.required %} *{% endif %}</legend>
                {% if field.field_type == 'textarea' %}
                <textarea class="textarea w-full" name="{{field.name}}" phx-blur="update_create_field" phx-value-field="{{field.name}}" rows="3" autocomplete="off">{{field.value}}</textarea>
                {% elif field.field_type == 'select' %}
                <select class="select w-full" name="{{field.name}}" phx-change="update_create_field" phx-value-field="{{field.name}}">
                    <option value="">-- Select --</option>
                    {% for choice in field.choices %}
                    <option value="{{choice.0}}">{{choice.1}}</option>
                    {% endfor %}
                </select>
                {% elif field.field_type == 'checkbox' %}
                <input type="checkbox" class="checkbox" name="{{field.name}}" phx-change="update_create_field" phx-value-field="{{field.name}}" {% if field.value %}checked{% endif %} />
                {% elif field.field_type == 'date' %}
                <input type="date" class="input w-full" name="{{field.name}}" value="{{field.value}}" phx-blur="update_create_field" phx-value-field="{{field.name}}" />
                {% elif field.field_type == 'number' %}
                <input type="number" class="input w-full" name="{{field.name}}" value="{{field.value}}" phx-blur="update_create_field" phx-value-field="{{field.name}}" autocomplete="off" />
                {% else %}
                <input type="text" class="input w-full" name="{{field.name}}" value="{{field.value}}" phx-blur="update_create_field" phx-value-field="{{field.name}}" autocomplete="off" />
                {% endif %}
            </fieldset>
            {% endfor %}
            <div class="card-actions justify-end mt-4">
                <button class="btn btn-ghost" phx-click="cancel_create">Cancel</button>
                <button class="btn btn-primary" phx-click="save_create">Create</button>
            </div>
        </div>
    </div>
    {% endif %}

    <div class="space-y-4" id="cards-list" phx-hook="Sortable">
        {% for item in items %}
        <div class="card bg-base-100 shadow-sm" id="card-{{item.id}}" data-card-id="{{item.id}}">
            <div class="card-body">
                <div class="flex items-center gap-2">
                    <div class="cursor-grab text-base-content/40 hover:text-base-content drag-handle">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8h16M4 16h16" />
                        </svg>
                    </div>

                    {% if item.title_editing %}
                    <div class="field-edit flex-1" id="edit-{{item.id}}-{{item.title_field_name}}" phx-hook="AutoFocus">
                        <input type="text" class="input input-primary w-full" name="value" value="{{item.title_editing_value}}" phx-keyup="update_draft" phx-value-item_id="{{item.id}}" phx-value-field="{{item.title_field_name}}" autocomplete="off" />
                        <div class="flex gap-2 mt-2">
                            <button class="btn btn-primary btn-sm" phx-click="save_edit" phx-value-item_id="{{item.id}}" phx-value-field="{{item.title_field_name}}">Save</button>
                            <button class="btn btn-ghost btn-sm" phx-click="cancel_edit" phx-value-item_id="{{item.id}}" phx-value-field="{{item.title_field_name}}">Cancel</button>
                        </div>
                    </div>
                    {% else %}
                    {% if item.title_locked %}
                    <h2 class="card-title flex-1 opacity-50 cursor-not-allowed">{{item.title_html}}</h2>
                    {% else %}
                    <h2 class="card-title flex-1 cursor-pointer hover:text-primary" phx-click="start_edit" phx-value-item_id="{{item.id}}" phx-value-field="{{item.title_field_name}}">{{item.title_html}}</h2>
                    {% endif %}

                    <div class="dropdown dropdown-end">
                        <div tabindex="0" role="button" class="btn btn-ghost btn-sm btn-square">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z" />
                            </svg>
                        </div>
                        <ul tabindex="-1" class="dropdown-content menu p-2 shadow-sm bg-base-100 rounded-box w-40 z-1">
                            {% if filters %}
                            <li><a phx-click="unlink_item" phx-value-item_id="{{item.id}}">Unlink</a></li>
                            {% endif %}
                            <li><a id="delete-{{item.id}}" class="text-error" phx-hook="ConfirmClick" data-confirm="Delete this item?" phx-click="delete_item" phx-value-item_id="{{item.id}}">Delete</a></li>
                        </ul>
                    </div>
                    {% endif %}
                </div>

                {% for field in item.content_fields_data %}
                <div class="mt-4">
                    {% if field.is_editing %}
                    <div class="field-edit" id="edit-{{item.id}}-{{field.name}}" phx-hook="AutoFocus">
                        <textarea class="textarea textarea-primary w-full" name="value" phx-keyup="update_draft" phx-value-item_id="{{item.id}}" phx-value-field="{{field.name}}" rows="3">{{field.editing_value}}</textarea>
                        <div class="flex gap-2 mt-2">
                            <button class="btn btn-primary btn-sm" phx-click="save_edit" phx-value-item_id="{{item.id}}" phx-value-field="{{field.name}}">Save</button>
                            <button class="btn btn-ghost btn-sm" phx-click="cancel_edit" phx-value-item_id="{{item.id}}" phx-value-field="{{field.name}}">Cancel</button>
                        </div>
                    </div>
                    {% else %}
                    {% if field.is_locked %}
                    <div class="prose opacity-50 cursor-not-allowed">{{field.value_html}}</div>
                    {% else %}
                    <div class="prose cursor-pointer hover:bg-base-200 p-2 -m-2 rounded" phx-click="start_edit" phx-value-item_id="{{item.id}}" phx-value-field="{{field.name}}">{{field.value_html}}</div>
                    {% endif %}
                    {% endif %}
                </div>
                {% endfor %}

                {% if item.dive_buttons %}
                <div class="card-actions justify-end mt-4">
                    {% for btn in item.dive_buttons %}
                    <a href="{{btn.url}}" class="btn btn-outline btn-sm">{{btn.label}} &rarr;</a>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>

    {% if picker_open %}
    <div class="picker-modal fixed inset-0 bg-black/50 flex items-center justify-center z-50">
        <div class="bg-base-100 rounded-lg shadow-lg w-full max-w-md max-h-[80vh] flex flex-col">
            <div class="p-4 border-b border-base-300">
                <h3 class="text-lg font-bold">Add Existing {{model_name_singular}}</h3>
            </div>
            <div class="p-4 overflow-y-auto flex-1">
                {% if picker_items %}
                <div class="space-y-2">
                    {% for item in picker_items %}
                    <button type="button" class="flex items-center gap-3 p-2 rounded hover:bg-base-200 cursor-pointer w-full text-left" phx-click="toggle_picker_item" phx-value-item_id="{{item.id}}">
                        <input type="checkbox" class="checkbox pointer-events-none" {% if item.selected %}checked{% endif %} />
                        <span>{{item.title}}</span>
                    </button>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-base-content/70">No items available to add.</p>
                {% endif %}
            </div>
            <div class="p-4 border-t border-base-300 flex justify-end gap-2">
                <button class="btn btn-ghost" phx-click="close_picker">Cancel</button>
                <button class="btn btn-primary" phx-click="confirm_picker" {% if not picker_has_selection %}disabled{% endif %}>Add Selected</button>
            </div>
        </div>
    </div>
    {% endif %}
</div>
