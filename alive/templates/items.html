<div class="cards-container">
    <div class="list-header">
        <h1>{{model_name}}</h1>
        {% if not creating %}
        <button class="add-button" phx-click="start_create">+ Add</button>
        {% endif %}
    </div>
    {% if filter_description %}
    <div class="filter-bar">
        {% if filter_back_url %}
        <a href="javascript:history.back()" class="filter-description filter-link">&larr; {{filter_description}}</a>
        {% else %}
        <span class="filter-description">{{filter_description}}</span>
        {% endif %}
        <a href="?" class="clear-filter">Show all</a>
    </div>
    {% endif %}

    {% if creating %}
    <div class="card create-card">
        <div class="card-header">
            <div class="title-content"><p>New {{model_name_singular}}</p></div>
        </div>
        <div class="card-body create-form" phx-hook="AutoFocus">
            {% if create_error %}
            <div class="create-error">{{create_error}}</div>
            {% endif %}
            {% for field in create_fields %}
            <div class="create-field">
                <label for="create-{{field.name}}">
                    {{field.label}}{% if field.required %} *{% endif %}
                </label>
                {% if field.field_type == 'textarea' %}
                <textarea id="create-{{field.name}}" name="{{field.name}}" phx-blur="update_create_field" phx-value-field="{{field.name}}" rows="3" autocomplete="off">{{field.value}}</textarea>
                {% elif field.field_type == 'select' %}
                <select id="create-{{field.name}}" name="{{field.name}}" phx-change="update_create_field" phx-value-field="{{field.name}}">
                    <option value="">-- Select --</option>
                    {% for choice in field.choices %}
                    <option value="{{choice.0}}">{{choice.1}}</option>
                    {% endfor %}
                </select>
                {% elif field.field_type == 'checkbox' %}
                <input type="checkbox" id="create-{{field.name}}" name="{{field.name}}" phx-change="update_create_field" phx-value-field="{{field.name}}" {% if field.value %}checked{% endif %} />
                {% elif field.field_type == 'date' %}
                <input type="date" id="create-{{field.name}}" name="{{field.name}}" value="{{field.value}}" phx-blur="update_create_field" phx-value-field="{{field.name}}" />
                {% elif field.field_type == 'number' %}
                <input type="number" id="create-{{field.name}}" name="{{field.name}}" value="{{field.value}}" phx-blur="update_create_field" phx-value-field="{{field.name}}" autocomplete="off" />
                {% else %}
                <input type="text" id="create-{{field.name}}" name="{{field.name}}" value="{{field.value}}" phx-blur="update_create_field" phx-value-field="{{field.name}}" autocomplete="off" />
                {% endif %}
            </div>
            {% endfor %}
            <div class="edit-buttons">
                <button phx-click="save_create">Create</button>
                <button phx-click="cancel_create">Cancel</button>
            </div>
        </div>
    </div>
    {% endif %}

    <div class="cards-list" id="cards-list" phx-hook="Sortable">
        {% for item in items %}
        <div class="card" id="card-{{item.id}}" data-card-id="{{item.id}}">
            <div class="card-header">
                <div class="drag-handle" title="Drag to reorder">&#9776;</div>

                {% if item.title_editing %}
                <div class="field-edit" id="edit-{{item.id}}-{{item.title_field_name}}" phx-hook="AutoFocus">
                    <input type="text" name="value" value="{{item.title_editing_value}}" phx-keyup="update_draft" phx-value-item_id="{{item.id}}" phx-value-field="{{item.title_field_name}}" autocomplete="off" />
                    <div class="edit-buttons">
                        <button phx-click="save_edit" phx-value-item_id="{{item.id}}" phx-value-field="{{item.title_field_name}}">Save</button>
                        <button phx-click="cancel_edit" phx-value-item_id="{{item.id}}" phx-value-field="{{item.title_field_name}}">Cancel</button>
                    </div>
                </div>
                {% else %}
                {% if item.title_locked %}
                <div class="field-display locked">
                    <div class="title-content">{{item.title_html}}</div>
                </div>
                {% else %}
                <div class="field-display" phx-click="start_edit" phx-value-item_id="{{item.id}}" phx-value-field="{{item.title_field_name}}">
                    <div class="title-content">{{item.title_html}}</div>
                </div>
                {% endif %}
                {% endif %}

                <div class="move-buttons">
                    <button phx-click="move_item" phx-value-item_id="{{item.id}}" phx-value-direction="-1" title="Move up">&#9650;</button>
                    <button phx-click="move_item" phx-value-item_id="{{item.id}}" phx-value-direction="1" title="Move down">&#9660;</button>
                </div>
            </div>

            {% for field in item.content_fields_data %}
            <div class="card-body">
                {% if field.is_editing %}
                <div class="field-edit" id="edit-{{item.id}}-{{field.name}}" phx-hook="AutoFocus">
                    <textarea name="value" phx-keyup="update_draft" phx-value-item_id="{{item.id}}" phx-value-field="{{field.name}}" rows="3">{{field.editing_value}}</textarea>
                    <div class="edit-buttons">
                        <button phx-click="save_edit" phx-value-item_id="{{item.id}}" phx-value-field="{{field.name}}">Save</button>
                        <button phx-click="cancel_edit" phx-value-item_id="{{item.id}}" phx-value-field="{{field.name}}">Cancel</button>
                    </div>
                </div>
                {% else %}
                {% if field.is_locked %}
                <div class="field-display locked">
                    <div class="content-text">{{field.value_html}}</div>
                </div>
                {% else %}
                <div class="field-display" phx-click="start_edit" phx-value-item_id="{{item.id}}" phx-value-field="{{field.name}}">
                    <div class="content-text">{{field.value_html}}</div>
                </div>
                {% endif %}
                {% endif %}
            </div>
            {% endfor %}

            {% if item.dive_buttons %}
            <div class="card-footer">
                <div class="dive-buttons">
                    {% for btn in item.dive_buttons %}
                    <a href="{{btn.url}}" class="dive-button">{{btn.label}} &rarr;</a>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>
        {% endfor %}
    </div>
</div>
